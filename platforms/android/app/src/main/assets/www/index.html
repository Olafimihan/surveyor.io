<!DOCTYPE html>
<!--
    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
     KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
-->
<html>
    <head>
        <meta charset="utf-8" />
        <meta name="format-detection" content="telephone=no" />
        <!-- WARNING: for iOS 7, remove the width=device-width and height=device-height attributes. See https://issues.apache.org/jira/browse/CB-4323 -->
        <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width, height=device-height, target-densitydpi=device-dpi" />
        <link rel="stylesheet" type="text/css" href="css/index.css" />
        <meta name="msapplication-tap-highlight" content="no" />
        <link href="css/root.css" rel="stylesheet">

        <link rel="stylesheet" href="public/css/plugin/sweet-alert/sweet-alert.css">


        <link rel="stylesheet" href="css/flickity.css">
        <!-- <link href="https://unpkg.com/flickity@2/dist/flickity.min.css" rel="stylesheet"/> -->
            <link rel="stylesheet" href="css/flickity.min.css" media="screen">

        <!-- <link href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/css/bootstrap.min.css" rel="stylesheet"/> -->
            <link rel="stylesheet" href="css/bootstrap-4.0.css" >



          
            <!-- <script src="js/jquery-3.3.1.js"></script> -->
        <!-- <script src="https://code.jquery.com/jquery-3.1.1.slim.min.js"></script> -->
            <!-- <script src="js/jquery.min.js"></script> -->

        
        <!-- <script src="https://cdnjs.cloudflare.com/ajax/libs/tether/1.4.0/js/tether.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-alpha.6/js/bootstrap.min.js"></script> -->

        <!-- <script src="https://unpkg.com/flickity@2/dist/flickity.pkgd.min.js"></script> -->
            

        <title>Survey Planet.io</title>


        <!-- ========== Css Files ========== -->
        
        <!-- <link rel="stylesheet" href="https://fonts.googleapis.com/icon?family=Material+Icons">    
        <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/css/bootstrap.min.css" >
        <link rel="stylesheet" href="css/flickity.min.css" media="screen"> -->
    
    
        
        <!-- <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.2.1/js/bootstrap.min.js" ></script>
        <script src="js/jquery-3.3.1.js"></script>
        <script src="js/flickity.min.js" ></script> -->

        <script>
          var myVar = setInterval(myTimer ,1000);
          var _myBlinker = setInterval(blinker ,1000);

          

          // if(jQuery) {
          //   alert('jQuery is loaded.');
          // } else {
          //   alert('jQuery NOT loaded.');
          // }

          function myTimer() {
            var d = new Date();
            document.getElementById("timer").innerHTML = d.toDateString()+" AT "+d.toLocaleTimeString();
          }
          function blinker() {
            // alert('dele')
            $('.blinking').fadeOut(500);
            $('.blinking').fadeIn(500);
          }

        </script>
    
        <style type="text/css">
            body {
              background: skyblue;
              /* height: 100%; */
            }

            .main-carousel {
              background: whitesmoke;
              color: #000;

            }

            p {
              background-color: whitesmoked;
              width: 100%;
              /* text-align: left; */
              margin-left: auto;
              margin-right: auto; 
              font-size: 14px;
              font-weight: bolder;
              color: #000;
              text-align: center;
              justify-content: left;
              text-justify: auto;
              margin: 1px;
              display: inline-block;
            }
            
            .carousel-cell {
                color: black;
                /* font-size: px; */
                
                width: 100%;
                height: 500px;
                overflow: scroll;
                
                /* display: flex; */
                align-items: center;

                margin-right: auto;
                margin-left: auto; 
                text-align: center;
                
                /* overflow: scroll; */
                /* background-color: red; */
                
                /* font-family: Verdana, Geneva, Tahoma, sans-serif;
                
                justify-content: center; */
            }

            /* .carousel.is-fullscreen .carousel-cell {
                height: 70%;
            } */

            h3 {
                margin: 2px;
            }

            .flickity-button {
              background: gray;
              /* background: peru; */
            }

            .flickity-button:hover {
              background: #F90;
            }

            .flickity-prev-next-button {
              width: 50px;
              height: 50px;
              border-radius: 60px;
            }

            /* icon color */
            .flickity-button-icon {
              fill: white;
            }

            .flickity-prev-next-button {
              top: 40px;
              -webkit-transform: none;
                      transform: none;
            }

            .flickity-prev-next-button.previous {
              left: auto;
              right: 60px;
            }

            .flickity-prev-next-button.next {
              right: 10px;
            }

            /* position outside */
            /* .flickity-prev-next-button.previous {
              left: -40px;
            } */

            /* .flickity-prev-next-button.next {
              right: -40px;
            } */

            /* hide disabled button */
            /* .flickity-button:disabled {
              display: none;
            } */

        </style>
        
    </head>

    <body>
        <!-- <h2  style="text-align: center; font-family: 'Times New Roman', Times, serif; color: #fff" >MRC Survey Demo</h2> -->
        <div>
          <div >
            <h1 style="text-align: center; margin-top: 15px;" id="proj"></h1>
            <h6 class="hidden" style="text-align: center; font-style: normal; color: rgb(134, 123, 123)" id="timer"></h6>
            
          </div>
          
          <div class="alert alert-success hidden">
            <strong>Success!</strong> <p id='succ'></p>.
            <!-- <audio src=""></audio> -->
          </div>
          
          <div class="alert alert-info hidden">
            <strong>Info!</strong> Indicates a neutral informative change or action.
          </div>
          
          <div class="alert alert-warning hidden">
            <strong>Warning!</strong> Indicates a warning that might need attention.
          </div>
          
          <div class="alert alert-danger hidden">
            <strong>Danger!</strong> <p id='dang'></p>.
          </div>

        </div>
        <div class="login-form singin" style="margin-top: 0px;">
            <form action="">
              <!-- <audio src=""></audio> -->
              <div class="top">
                <img src="http://75.127.75.161/sprimages/surveylogo.jpg" alt="icon" width="450" height="400" class="icon">
                <h3>SurveyPlanet.io</h3>
                <!-- <h3>SurveyNinja.io</h3> -->
                <!-- <h4>Bootstrap Admin Template</h4> -->
              </div>
              <div class="form-area login">
                <div class="group">
                  <input type="text" class="form-control" id="user" name="user" placeholder="Username">
                  <i class="fa fa-user"></i>
                </div>
                <div class="group">
                  <input type="password" class="form-control" id="pass" name="pass" placeholder="Password">
                  <i class="fa fa-key"></i>
                </div>
                <div class="checkbox checkbox-primary">
                  <input id="checkbox101" type="checkbox" checked>
                  <label for="checkbox101"> Remember Me</label>
                </div>
                <button type="button" id="logins" class="btn btn-success btn-block">LOGIN</button>
                <button type="button" id="cleanup" class="btn btn-primary" >CleanUp</button><p id='im'></p>
                <!-- <button type="button" id="conns" class="btn btn-default btn-block">Check Connection</button> -->
                <!-- <button type="button" id="conns" onclick="routeLogin()" class="btn btn-default btn-block">Check Connection</button> -->
              </div>
 
            </form>

            <div class="footer-links row hidden" >
              <div class="col-xs-6"><a href="#"><i class="fa fa-external-link"></i> Register Now</a></div>
              <div class="col-xs-6 text-right"><a href="#"><i class="fa fa-lock"></i> Forgot password</a></div>
            </div>

          </div>

          <div class="form opts hidden" style="background-color: whitesmoke;">
            <div>
              <table class="table table-hover">
                <tr style="font-size: 22px; font-weight: bold; font-style: normal; text-align: center">

                  <!-- <td id='project_title'>

                  </td> -->

                </tr>

                <!-- <tr>
                  <td>
                    <button class="btn btn-success" type="button" onclick="openQuestionaire()"  >Start New Survey</button>
                  </td>
                </tr> -->

                <tr>
                  <td>
                    <button class="btn btn-success btn-lg col-md-6">
                        Unsubmitted Forms:  <span   class="badge">5</span>
                    </button>
                  </td>
                </tr>

                <tr>
                  <td>
                    <button class="btn btn-primary btn-lg col-md-12" type="button" id="new_form" onclick="openQuestionaire()" >
                      Start Survey  <span style="font-size: 12px; " ><i class="fa fa-file"></i></span>
                    </button>
                  </td>
                </tr>
                <tr>
                  <td>
                    <button class="btn btn-primary btn-lg col-md-12" type="button" onclick="getCoordinate()" >
                        Check my Location  <span style="font-size: 12px; " ><i class="fa fa-gps"></i></span>
                    </button>
                  </td>
                </tr>
                <tr class="gpscoordinate" style="background-color: whitesmoke; color: black; font-size: 14px">
                  <td id="gpscoordinates">

                  </td>
                </tr>
                <tr>
                  <td>
                    <button class="btn btn-primary btn-lg col-md-12">
                        Sync Server  <span style="font-size: 12px; " ><i class="fa fa-sync"></i></span>
                    </button>
                  </td>
                </tr>
  
              </table>
                 
            </div>
   
          </div>
          <div class="pict hidden" style="width: 394px;">
            <img src="http://75.127.75.161/sprimages/intervies.gif" alt="" width="auto" height="auto">

          </div>

          <div class="login-form reg hidden">
              <!-- <h2  style="text-align: center; font-family: 'Times New Roman', Times, serif; color: #fff" >MRC Survey Demo</h2> -->
              
            <form action="">
              <div class="top">
                <h1>Register</h1>
                <h4>Join our community now !</h4>
              </div>
              <div class="form-area">
                <div class="group">
                  <input type="text" class="form-control" id="username" placeholder="Username">
                  <i class="fa fa-user"></i>
                </div>
                <div class="group">
                  <input type="text" class="form-control" id="email" placeholder="E-mail">
                  <i class="fa fa-envelope-o"></i>
                </div>
                <div class="group">
                  <input type="number" class="form-control" id="phone" placeholder="Telephone">
                  <i class="fa fa-phone"></i>
                </div>
                
                <button type="button" id="register" class="btn btn-default btn-block">REGISTER NOW</button>
                
              </div>
            </form>
            <div class="footer-links row ">
              <div class="col-xs-6"><a href="#"><i class="fa fa-sign-in"></i> Login</a></div>
              <div class="col-xs-6 text-right"><a href="#"><i class="fa fa-lock"></i> Forgot password</a></div>
            </div>
          </div>

          <!-- <div class="options ">

          </div> -->

          <div class="questionaire hidden">
              <!-- <h2  style="text-align: center; font-family: 'Times New Roman', Times, serif; color: #fff" >MRC Survey Demo</h2> -->
              <!-- <div class="button-group hidden">
                <button class="button">1</button>
                <button class="button">2</button>
                <button class="button">3</button>
                <button class="button">4</button>
                <button class="button">5</button>
              </div> -->
              <!-- cellAlign: 'left',
                  contain: true,
                  fullscreen: false, 
                  contain: true, 
                  pageDots: false, 
                  prevNextButtons : true
                  ,
                  fade: true -->
              
              <!--data-flickity='{ "cellAlign": "left", "contain": true, "fullscreen": false, "pageDots": false, "prevNextButtons" : true, "fade": true}'-->    

              <div style="color: #000" class="main-carousel"  > 
                  
              </div>
          </div>

          <script src="js/jquery-3.3.1.js"></script>
        <script src="public/js/sweet-alert/sweet-alert.min.js" type="text/javascript"></script>
        
    
        <script type="text/javascript" src="cordova.js"></script>
        <script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>

        <script src="js/flickity.min.js"></script>
        <script src="js/flickity.fade.js"></script>


        <script>
          // app.initialize();
        </script>

        <script type="text/javascript" src="js/index.js"></script>

        <script type="text/javascript">

          $(document).ready(()=>{

            $('#user').val(localStorage.getItem('username'))
            $('#pass').val(localStorage.getItem('passkey'))

            // $('#pass').val(upass);
            socket.on('connect', ()=>{
              socket.on('getter', (res)=>{
                // $('user').val(localStorage.getItem('username'))
                // $('pass').val(localStorage.getItem('passkey'))

                //alert(res);
              });
            });
            
          });
          app.initialize();

          var routeLogin = () => {
            // alert($('#user'))
            var user = 'dele';
            var pass = 'dele';
            var imei = 'dele1234';
            // alert(user);
            $.ajax({
              url: "http://75.127.75.161:4000/register",
              cache: false,
              type: "GET",
              data: "user="+user+"&pass="+pass,
              dataType: "JSON",
              success: function(data){
                // alert(data.ans);
                // console.log(data.ans);
                // console.log(data);
              },
              error: function(error){
                alert(error.statusText)
                alert(Object.keys(error));
              }
            });
 
          };

          var cleanup = () => {
            localStorage.removeItem('_surveytoken');
            var imei = localStorage.getItem('IMEI');
            $.ajax({
              url: "http://75.127.75.161:4000/resetdevice",
              cache: false,
              type: "GET",
              data: "imei="+imei,
              dataType: "JSON",
              success: function(data){
                alert(data);
                // console.log(data.ans);
                // console.log(data);
              },
              error: function(error){
                // alert(error.statusText)
                // alert(Object.keys(error));
              }
            });
 

          }
          
          function trackInputFiles() {
            var file=null;
            var reader=null;

            var reader = new FileReader();
            var file = document.getElementById('imgname').files[0];

            var reader = new FileReader();
            // $("#main").show('slow'); 

            // Closure to capture the file information.
            reader.onload = (function(theFile) {
              return function(e) {
                // Render thumbnail.
                var span = document.createElement('span');

                var nm = theFile.name;
                var len= nm.length; 

                if(len > 50){
                    swal("Warning",theFile.type+" The File name length cannot be more than 50 letters!!!/n "+theFile.name, "warning");
                    return;
                }


                // if(theFile.type !='image/jpeg' && theFile.type != 'image/gif'){
                //     swal("Warning",theFile.type+" File type not allowed...JPEG and GIF File type are allowed here!!!", "warning");
                //     return;
                // }
                
                span.innerHTML = ['<img class="thumb" src="'+e.target.result+ '" width="350" height="250" title="'+ escape(theFile.name)+ '"/>'];

                $("#list").html('<img class="thumb" src="'+e.target.result+ '" width="350" height="250" title="'+ escape(theFile.name)+ '"/>');
              };
            })(file);

            // Read in the image file as a data URL.
            reader.readAsDataURL(file);

          }

    
          var questionaireLayout = (resObject) => { /** THE ONLINE CODE */
            // alert(resObject.questions);
            // console.log(resObject.questions);

            var counter=0;

            /**Insert into  LOCAL tables */

            var $maincarousel = $('.main-carousel');
        
            var questionsArray = resObject.questions;
            var optionsArray   = resObject.options;
            var projectid      = resObject.projectid;

            localStorage.setItem("projectid", projectid);
            
            var carouselhtmlString="";
            
            // console.log(optionsArray);

            
            // SQLite initiated for local action
            
            // surveyDB.transaction(function(tx) {
                /**WIRE THE questionaire into the phone SQLite database: surveydb.db
                 * DB NAME: surveydb.db
                 * ENGINE : Innodb
                 * Platform: SQLite Cordova Plugin
                 */

                // alert('dele');
            questionsArray.forEach(function(recs, idx) {

              counter++;
              carouselhtmlString += '<div class="carousel-cell">';

              var q_refnos = 0; var question = "";
              var q_required="", reqstat="", q_serialnumber=0;

              var min=0, max=0, min_v=0, max_v=0;
                          
              q_refnos       = questionsArray[idx].refnos;
              question       = questionsArray[idx].question; 
              q_required     = questionsArray[idx].required;
              q_serialnumber = questionsArray[idx].question_no;
    
              if (q_required=='yes') {
                $('.carousel').addClass('hidden');
                reqstat = "Response required"
                // carouselhtmlString += "<h6 style='text-align: center; background-color: #ffcccc; color: white; font-weight: bolder' >Question Requires response</h6></br>";
              } else {
                reqstat = "Not Required"
              }

              /** pick from here */
              // draw the traffic controller button
              // carouselhtmlString += '<button class="btn btn success controller" >' + question + '</button></br>'; 

              carouselhtmlString += '<h3 class="quest " style="margin: 2px; font-size: 18px; background-color: transparent; color: black" >' + question + '</h3></br>'; 
              carouselhtmlString += '<input class="responsetimer hidden" style="margin: 20px; font-size: 28px; background-color: whitesmoked; color: black" id="responsetimer" type="text" ></br>';  
              carouselhtmlString += '<input class="cur_gps hidden" style="margin: 20px; font-size: 28px; background-color: whitesmoked; color: black" id="cur_gps" type="text" ></br>'; 
              carouselhtmlString += '<h3 class="q_required hidden" style="margin: 2px; font-size: 8px; background-color: whitesmoked; color: black; font-style: italics" >'+ q_required +'</h3></br>';
        
              /***/
              
              // carouselhtmlString += '<h1 style="margin: 20px; font-size: 28px; background-color: whitesmoked; color: black" >' + question + '</h1></br>';  
              // carouselhtmlString += '<h3 style="margin: 20px; font-size: 28px; background-color: whitesmoked; color: black" ><p class="responsetimer"></p></h3></br>';  
    
              var filtered = filter( optionsArray, {question_id: q_refnos } );
    
              //Add the customly created Options for each question here...
              filtered.forEach(function(options, indx) {
                  var coltyp, idd, opt, ref, plh="";
                  var opturl="", gotoid="", fromid="";
    
                  ref     = filtered[indx].refnos;
                  coltyp  = filtered[indx].coltype; /**Tells me the type of option in focus, either img, aud, vid, txt, num, rad, chk, sel */
                  idd     = filtered[indx].question_id;
                  opt     = filtered[indx].response_text;

                  opturl  = filtered[indx].optionURL;
                  gotoid  = filtered[indx].gotoquestionid;
                  fromid  = filtered[indx].fromquestionid;
                  
                  min  = filtered[indx].min;
                  max  = filtered[indx].max;

                  min_v  = filtered[indx].min_v;
                  max_v  = filtered[indx].max_v;

                  // options += '<input type="text" id="'+idd+'" value="'+opt+'" placeholder="'+ opt +'" >' ;
                  if(coltyp=='txt') {
                      carouselhtmlString += '<p class="col-md-12" ><input class="chtype col-md-8"  data-arrival data-departure data-location data-index="'+idx+'" data-goto="'+gotoid+'" data-timed data-min="'+min+'" data-max="'+max+'" data-minv="'+min_v+'" data-maxv="'+max_v+'" style=" color: #000" type="text" name="'+idd+'" id="'+ref+'" ></p>' + '</br>' ;

                      // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="arrival_timer" id="' +ref+'#arr'+ '" ></p>' + '</br>' ;
                      // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="departure_timer" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;
                      // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="gpslocation" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;

                  }
                  else if(coltyp=='num') {
                      // carouselhtmlString += '<input class="chtype" type="number" name="'+idd+'" id="'+ref+'" value="'+opt+'" placeholder="'+opt+'" >' + '</br>';
                      carouselhtmlString += '<p class="col-md-12"><input class="chtype col-md-6" data-arrival data-departure data-location data-index="'+idx+'" data-goto="'+gotoid+'" data-timed data-min="'+min+'" data-max="'+max+'" data-minv="'+min_v+'" data-maxv="'+max_v+'"  style="color: #000" type="number" name="'+idd+'" id="'+ref+'" value="'+ opt +'" placeholder="'+opt+'" ></p>' + '</br>';

                      // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="arrival_timer" id="' +ref+'#arr'+ '" ></p>' + '</br>' ;
                      // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="departure_timer" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;
                      // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="gpslocation" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;

                  }
                  else if(coltyp=='rad') {
                      // console.log('Dele Olafimihan') <label for = "sizeSmall">small</label>
                      // <input type="radio" name="gender" value="male" checked> Male<br>

                      carouselhtmlString += '<p class="">' +opt+ '<input class="chtype form-control" data-arrival data-departure data-location data-gps data-index="'+idx+'" data-goto="'+gotoid+'" data-min="'+min+'" data-max="'+max+'" data-minv="'+min_v+'" data-maxv="'+max_v+'" data-timed type="radio" name="'+idd+'" id="'+ref+'" value="'+opt+'"  ></p></br>';

                      // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="arrival_timer" id="' +ref+'#arr'+ '" ></p>' + '</br>' ;
                      // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="departure_timer" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;
                      // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="gpslocation" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;

                      // carouselhtmlString += '<div style="text-align: center; background-color: red"><p><input type="radio" class="chtype" style="" name="'+idd+'" id="'+ref+'" value="'+opt+'"  >'+opt+'</p></div></br>';

                      // carouselhtmlString += '<p class="" style="background-color: pink; color: black" ><p class="" style="background-color: whitesmoked; color: black"> ' + opt + '</p> <p class="" ><input class="chtype" style="font-size: 12px; text-align: left" type="radio" name="'+idd+'" id="'+ref+'" value="'+opt+'"  ></p></p></br>';
                      // carouselhtmlString += '<div class="form-group col-md-8"><input class="chtype" type="radio" name="'+idd+'" id="'+ref+'" value="'+opt+'"  ></div> ' + opt + '</br>';
                  }
                  else if(coltyp=='chk') {
                      carouselhtmlString += '<p class="col-md-12"> <input class="chtype col-md-12" data-min="'+min+'" data-max="'+max+'" data-minv="'+min_v+'" data-maxv="'+max_v+'" data-arrival data-departure data-location data-gps data-index="'+idx+'" data-goto="'+gotoid+'" data-timed type="checkbox" name="'+idd+'" id="'+ref+'" value="'+opt+'" />'+opt+'</p></br>';

                      // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="arrival_timer" id="' +ref+'#arr'+ '" ></p>' + '</br>' ;
                      // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="departure_timer" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;
                      // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="gpslocation" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;

                  }
                  else if(coltyp=='img') {
                    carouselhtmlString += '<p class="col-md-8"><button class="chtype col-md-8 btn btn-primary" type="button" onclick="getCamera()"  name="'+idd+'" id="'+ref+'" value="'+ opt +'"  ><i class="fa fa-camera" ></i></button></p> </br>';

                    carouselhtmlString += '<p class="col-md-8"><input data-min="'+min+'" data-max="'+max+'" data-minv="'+min_v+'" data-maxv="'+max_v+'"  data-arrival data-departure data-location data-index="'+idx+'" data-goto="'+gotoid+'" data-timed class="chtype col-md-8 hidden" type="image" name="'+idd+'" id="'+ref+'" ></p> </br>';
                    carouselhtmlString += '<p class="col-md-12"><img class="chtype col-md-12" alt="myImage" name="myImage" id="myImage" ></p> </br>';
  // <input type="image" src="" alt="">
                
                      // Timer
                      // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="arrival_timer" id="' +ref+'#arr'+ '" ></p>' + '</br>' ;
                      // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="departure_timer" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;
                      // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="gpslocation" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;


                  }
                  else if(coltyp=='sel') {
                      carouselhtmlString += '<p ><select class="chtype  data-min="'+min+'" data-max="'+max+'" data-minv="'+min_v+'" data-maxv="'+max_v+'" data-arrival data-departure data-location data-index="'+idx+'" data-goto="'+gotoid+'" data-timed form-control" type="select" name="'+idd+'" id="'+ref+'" value="'+ opt +'" >'+'<option>'+ opt +'</option>'+'</select></p></br>' ;
                      // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="arrival_timer" id="' +ref+'#arr'+ '" ></p>' + '</br>' ;
                      // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="departure_timer" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;
                      // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="gpslocation" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;

                      // carouselhtmlString += '<p ><select class="chtype form-control" type="select" name="'+idd+'" id="'+ref+'" value="'+ opt +'" >'+'<option>'+ opt +'</option>'+'</select></p></br>' ;
                                                  
                      // carouselhtmlString += '</select>' ;
                  }
                  else if(coltyp=='aud') {
                    carouselhtmlString += '<p class="col-md-8"><button class="chtype col-md-8 btn btn-primary" type="button" onclick="getAudio()"  name="'+idd+'" id="'+ref+'" value="'+ opt +'"  ><i class="fa-file-audio-o" ></i></button></p> </br>';

                    carouselhtmlString += '<p class="col-md-8"><input data-min="'+min+'" data-max="'+max+'" data-minv="'+min_v+'" data-maxv="'+max_v+'"  data-arrival data-departure data-location data-index="'+idx+'" data-goto="'+gotoid+'" data-timed class="chtype col-md-8 hidden" type="audio" name="'+idd+'" id="'+ref+'" ></p> </br>';
                    carouselhtmlString += '<p class="col-md-12"><audio class="chtype" name="myAudio" id="myAudio" ></audio></p> </br>';
                  
                  }
                  else if(coltyp=='vid') {
                    carouselhtmlString += '<p class="col-md-8"><button class="chtype col-md-8 btn btn-primary" type="button" onclick="getAudio()"  name="'+idd+'" id="'+ref+'" value="'+ opt +'"  ><i class="fa fa-video-camera" ></i></button></p> </br>';

                    carouselhtmlString += '<p class="col-md-8"><input data-min="'+min+'" data-max="'+max+'" data-minv="'+min_v+'" data-maxv="'+max_v+'" data-arrival data-departure data-location data-index="'+idx+'" data-goto="'+gotoid+'" data-timed class="chtype col-md-8 hidden" type="audio" name="'+idd+'" id="'+ref+'" ></p> </br>';
                    carouselhtmlString += '<p class="col-md-12"><video class="chtype" name="myVideo" id="myVideo" ></p> </br>';
                  }
              });
    
              carouselhtmlString += '</div>'; 
        
            });    

            //This is the save button CONCAT below
            // carouselhtmlString += '<div class="carousel-cell" ><button type="button" name="save" id="save" class="btn btn-success" >Submit Survey</button></div>'
            carouselhtmlString += '<div class="carousel-cell" style="margin-top: 30px" >'+
                                    '<button type="button" name="save" id="save" onclick="saver()" class="btn btn-success btn-lg chtype" >Submit Survey</button></br>'+
                                    '<button type="button" name="refresh" id="refresh" onclick="refreshPage()" class="btn btn-primary btn-lg" > Refresh Form </button></br>'+

                                    '<div class="margint-top: 20px savebtn hidden">'+
                                        '<p class="blinking">saving, please wait...</p>'+
                                        '<p><img src="img/loading.gif" width="100" heigth="150" class="indeterminate chtype" id="progress" ></p>'+
                                    '</div>'+

                                  '</div>'
            // carouselhtmlString += '<div class="carousel-cell" style="margin-top: 30px" ><button type="button" name="save" id="save" onclick="saver()" class="btn btn-success" > Refresh Form</button></div>'
      
            // console.log(carouselhtmlString);
            
            $('.main-carousel').html(carouselhtmlString);
      
            $('.main-carousel').flickity({
                // options
                cellAlign: 'left',
                contain: true,
                fullscreen: false, 
                contain: true, 
                pageDots: false, 
                prevNextButtons : true,
                fade: true
      
            }); 
        
          };

          var $carousel = $('.main-carousel');

          // The Local device operation point
          var questionaireLocalLayout = () => {
            var counter=0;
            var surveyDB = window.sqlitePlugin.openDatabase({name: "surveydb.db", location: 'default'});
            // alert(Object(surveyDB));
            var $maincarousel = $('.main-carousel');
            surveyDB.transaction((tx) => {
              
              var carouselhtmlString="";

              var query = "SELECT * FROM questions_tbl";
              tx.executeSql(query, [], function (tx, resultSet) {
                // console.log();
                // console.log('Questions counted: '+resultSet.rows.length);

                for(x = 0; x < resultSet.rows.length; x++) {
                  counter++;
                  carouselhtmlString += '<div class="carousel-cell">LOCAL';

                  var q_refnos = 0; var question = "";
                  var q_required="", q_serialnumber=0;

                  q_refnos = resultSet.rows.item(x).refnos;
                  question = resultSet.rows.item(x).question; 
                  q_required = resultSet.rows.item(x).required;
                  q_serialnumber = resultSet.rows.item(x).question_no;
                  
                  if(q_required=='yes') {
                    $('.carousel').addClass('hidden');

                    // carouselhtmlString += "<h6 style='text-align: center; background-color: #ffcccc; color: white; font-weight: bolder' >Question Requires response</h6></br>";
                  }

                  /** pick from here */
                  carouselhtmlString += '<h3 class="quest " style="margin: 2px; font-size: 22px; background-color: transparent; color: black" >' + question + '</h3></br>'; 
                  carouselhtmlString += '<input class="responsetimer hidden" style="margin: 20px; font-size: 28px; background-color: whitesmoked; color: black" id="responsetimer" type="text" /></br>';  
                  // carouselhtmlString += '<h3 class="q_required hidden" style="margin: 20px; font-size: 28px; background-color: whitesmoked; color: black" >'+ q_required +'</h3></br>';  
        
                  tx.executeSql("select * from options_tbl where question_id = ?", [q_refnos], function(t, res){
                    // console.log('Options counted: '+res.rows.length);
                    for(var y = 0; y < res.rows.length; y++) { /** pick all options for each question */
                    
                      var coltyp, idd, opt, ref, plh="";
                      var opturl="", gotoid="", fromid="";
        
                      ref     = res.rows.item(y).refnos; //filtered[indx].refnos;
                      
                      idd     = res.rows.item(y).question_id;
                      opt     = res.rows.item(y).response_text;
                      opturl  = res.rows.item(y).optionURL;
                      gotoid  = res.rows.item(y).gotoquestionid;
                      fromid  = res.rows.item(y).fromquestionid;
                      // fromid  = filtered[indx].fromquestionid;

                      coltyp  = res.rows.item(y).coltype; /**Tells me the type of option in focus, either img, aud, vid, txt, num, rad, chk, sel */
                       
                      // console.log(opt+":::"+coltyp)
                      if(coltyp=='txt') {
                          carouselhtmlString += '<p class="col-md-12" ><input class="chtype  col-md-12" data-arrival data-departure data-location data-index="'+idx+'" data-goto="'+gotoid+'" data-timed style=" color: #000" type="text" name="'+idd+'" id="'+ref+'" ></p>' + '</br>' ;

                          // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="arrival_timer" id="' +ref+'#arr'+ '" ></p>' + '</br>' ;
                          // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="departure_timer" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;
                          // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="gpslocation" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;

                      }
                      else if(coltyp=='num') {
                          // carouselhtmlString += '<input class="chtype" type="number" name="'+idd+'" id="'+ref+'" value="'+opt+'" placeholder="'+opt+'" >' + '</br>';
                          carouselhtmlString += '<p class="col-md-8"><input class="chtype col-md-12" data-arrival data-departure data-location data-index="'+idx+'" data-goto="'+gotoid+'" data-timed style="color: #000" type="number" name="'+idd+'" id="'+ref+'" value="'+ opt +'" placeholder="'+opt+'" ></p>' + '</br>';

                          // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="arrival_timer" id="' +ref+'#arr'+ '" ></p>' + '</br>' ;
                          // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="departure_timer" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;
                          // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="gpslocation" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;

                      }
                      else if(coltyp=='rad') {
                          // console.log('Dele Olafimihan') <label for = "sizeSmall">small</label>
                          // <input type="radio" name="gender" value="male" checked> Male<br>

                          carouselhtmlString += '<p><input class="chtype" data-arrival data-departure data-location data-gps data-index="'+idx+'" data-goto="'+gotoid+'" data-timed type="radio" name="'+idd+'" id="'+ref+'" value="'+opt+'"  />'+opt+'</p></br>';

                          // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="arrival_timer" id="' +ref+'#arr'+ '" ></p>' + '</br>' ;
                          // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="departure_timer" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;
                          // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="gpslocation" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;

                          // carouselhtmlString += '<div style="text-align: center; background-color: red"><p><input type="radio" class="chtype" style="" name="'+idd+'" id="'+ref+'" value="'+opt+'"  >'+opt+'</p></div></br>';

                          // carouselhtmlString += '<p class="" style="background-color: pink; color: black" ><p class="" style="background-color: whitesmoked; color: black"> ' + opt + '</p> <p class="" ><input class="chtype" style="font-size: 12px; text-align: left" type="radio" name="'+idd+'" id="'+ref+'" value="'+opt+'"  ></p></p></br>';
                          // carouselhtmlString += '<div class="form-group col-md-8"><input class="chtype" type="radio" name="'+idd+'" id="'+ref+'" value="'+opt+'"  ></div> ' + opt + '</br>';
                      }
                      else if(coltyp=='chk') {
                          carouselhtmlString += '<p> <input class="chtype" data-arrival data-departure data-location data-gps data-index="'+idx+'" data-goto="'+gotoid+'" data-timed type="checkbox" name="'+idd+'" id="'+ref+'" value="'+opt+'" />'+opt+'</p></br>';

                          // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="arrival_timer" id="' +ref+'#arr'+ '" ></p>' + '</br>' ;
                          // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="departure_timer" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;
                          // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="gpslocation" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;

                      }
                      else if(coltyp=='img') {
                        carouselhtmlString += '<p class="col-md-8"><button class="chtype col-md-8 btn btn-primary" data-arrival data-departure data-location data-index="'+idx+'" data-goto="'+gotoid+'" data-timed type="button" onclick="getCamera()"  name="'+idd+'" id="'+ref+'" value="'+ opt +'"  >'+opt + '<i class="fa fa-camera" ></i></button></p> </br>';

                          carouselhtmlString += '<p class="col-md-8"><input class="chtype col-md-8" name="imgname" id="imgname" ></p> </br>';
                          carouselhtmlString += '<p class="col-md-12"><img class="chtype col-md-12" width="100" height="auto" alt="myImage" name="myImage" id="myImage" ></p> </br>';

                          // Timer
                          // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="arrival_timer" id="' +ref+'#arr'+ '" ></p>' + '</br>' ;
                          // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="departure_timer" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;
                          // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="gpslocation" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;


                      }
                      else if(coltyp=='sel') {
                          carouselhtmlString += '<p ><select class="chtype form-control"  data-arrival data-departure data-location data-index="'+idx+'" data-goto="'+gotoid+'" data-timed type="select" name="'+idd+'" id="'+ref+'" value="'+ opt +'" >'+'<option>'+ opt +'</option>'+'</select></p></br>' ;
                          // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="arrival_timer" id="' +ref+'#arr'+ '" ></p>' + '</br>' ;
                          // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="departure_timer" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;
                          // carouselhtmlString += '<p class="col-md-12" ><input style=" color: #000" class="chtype col-md-12" type="hidden" name="gpslocation" id="' +ref+'#dep'+ '" ></p>' + '</br>' ;

                          // carouselhtmlString += '<p ><select class="chtype form-control" type="select" name="'+idd+'" id="'+ref+'" value="'+ opt +'" >'+'<option>'+ opt +'</option>'+'</select></p></br>' ;
                                                      
                          // carouselhtmlString += '</select>' ;
                      }
                    } /** End of options pick */

                    // console.log(carouselhtmlString)


                  }, function(err){
                    console.log("Option pick Error: "+err);
                  })

                  carouselhtmlString += '</div>';

                  // console.log("refnos: " + resultSet.rows.item(x).passkey +
                  //         ", Question: " + resultSet.rows.item(x).passkey );

                        
                }
                // some business logic code here
                  
                //This is the save button CONCAT below
                // carouselhtmlString += '<div class="carousel-cell" ><button type="button" name="save" id="save" class="btn btn-success" >Submit Survey</button></div>'
                carouselhtmlString += '<div class="carousel-cell" style="margin-top: 30px" >'+
                                      '<button type="button" name="save" id="save" onclick="saver()" class="btn btn-success btn-lg btn-block" >Submit Survey</button>'+
                                      '<button type="button" name="refresh" id="refresh" onclick="refreshPage()" class="btn btn-primary btn-lg btn-block" > Refresh Form </button>'
                                      '</div>';
                // carouselhtmlString += '<div class="carousel-cell" style="margin-top: 30px" ><button type="button" name="save" id="save" onclick="saver()" class="btn btn-success" > Refresh Form</button></div>'

                // console.log(carouselhtmlString);
                // alert(carouselhtmlString);
                
                $maincarousel.html(carouselhtmlString);

                $maincarousel.flickity({
                    // options
                    cellAlign: 'left',
                    contain: true,
                    fullscreen: false, 
                    contain: true, 
                    pageDots: false, 
                    prevNextButtons : true,
                    fade: true
                }); 

              },
              function (tx, error) {
                  console.log('SELECT error: ' + error.message);
              }); 

              // var questionsArray = resObject.questions;
              // var optionsArray   = resObject.options;
              // var projectid      = resObject.projectid; 

            }, function(err) {
              console.log('Questionaire pick error: '+err);
              surveyDB.close();
            }, function() {
              console.log('Questions picked ok...');
              surveyDB.close();
            }) 

          }

          // function filters(arr, criteria) {
          //     return arr.filters(function(obj) {
          //         return Object.keys(criteria).every(function(c) {
          //         return obj[c] == criteria[c];
          //         });
          //     });
          // }; 


          // $carousel.on( 'select.flickity', function( event, index ) {
          //   // console.log( 'Flickity select ' + index );
          //   // console.log( $('.quest').html() );
            
          // });

          $carousel.on( 'ready.flickity', function() { /** Upon readiness of the flickity plugin */
            console.log('Flickity ready');
            var d = new Date();
            var tt = d.toLocaleTimeString();

            var parentDOM = document.getElementsByClassName("carousel-cell")[0].getElementsByClassName("chtype");//
            // var arrivalDOM = parentDOM.getElementsByName('arrival_timer'); //
            //.value = tt // The moving page to be checked for null value
            // write to all element by looping through class
            name = parentDOM[0].name;
            typ = parentDOM[0].type;

            // console.log(parentDOM.length);
            // console.log(parentDOM);

            // data-arrival data-departure data-location data-index="'+idx+'" data-goto="'+gotoid+'" data-timed 

            for(var j=0; j <= parentDOM.length-1; j++){ // the -1 prevent processing undefined object
              parentDOM[j].dataset.arrival=tt; /** set the timestamp into dataset  */
              parentDOM[j].dataset.location=localStorage.getItem("geolocation"); /** set the timestamp into dataset  */

            }

            /** INit the Router Array 
             *  Using localStorage func
            */


          }); // end carousel ready



          
          // jQuery  

          /***************************************
           * this is the change event code for the plugin
           * 
           * 
           */
          $carousel.on( 'change.flickity', function( event, index ) {

            if(index !=='undefined') {
              var nextQuestionIndex=0;
              
              console.log(event.timeStamp);
              console.log(event.timeStamp.toLocaleString);

              console.log("Current index: "+index);
              // var parentDOM = document.getElementsByClassName("carousel-cell")[index].getElementsByClassName("chtype");//
              
              /**  GET the previous DOM elements OBJECTS
              * 
              */
              
              // var parentDOMst  = document.getElementsByClassName("carousel-cell")[index].getElementsByClassName("chtype");//
              // console.log(index);

              
              // var q_req = document.getElementsByClassName("carousel-cell")[index - 1].getElementsByClassName("q_required")[0].innerHTML;
              var opt_elementofQuest="";
              var parentDOM ="";

              if(index > 0) { //I can BUILD the TRAFFIC CONTROLLER around here
                parentDOM = document.getElementsByClassName("carousel-cell")[index - 1];// The moving page to be checked for null value
                // console.log(parentDOM);
                opt_elementofQuest = document.getElementsByClassName("carousel-cell")[index - 1].getElementsByClassName("chtype"); //Get the chtype class from parent DOM of the previous carousel page
                // console.log(opt_elementofQuest);
              }else if(index==0) {
                parentDOM = document.getElementsByClassName("carousel-cell")[index];// The moving page to be checked for null value
                opt_elementofQuest = document.getElementsByClassName("carousel-cell")[index].getElementsByClassName("chtype"); //Get the chtype class from parent DOM of the previous carousel page
              
              }
              
              var elmtype, elchkst;
              var pg_pusher = false;

              var d = new Date();
              var tt = d.toLocaleTimeString();
              var name, typ;

              // ensuring no BLANK value
              // need to know the type of element in view of the previous page
              // console.log("Previous element dom cnt: "+opt_elementofQuest.length)
              for (k = 0; k < opt_elementofQuest.length; k++) { // looking through the elements in previous page
                elmtype = opt_elementofQuest[k].type;
                // console.log(elmtype);

                opt_elementofQuest[k].dataset.departure = tt;
                if(elmtype=="radio") {
                  // treat radio element
                  // opt_elementofQuest[k].dataset.departure=tt;
                  elchkst = opt_elementofQuest[k].checked; /** Get the checked status of current radio elm */
                  // console.log(elchkst);
                  if(elchkst) {
                    // get the gotoid at this point
                    var dataset=opt_elementofQuest[k].dataset;
                    nextQuestionIndex = opt_elementofQuest[k].dataset.goto;

                    localStorage.setItem("fromid", index);
                    localStorage.setItem("GotoIdx", nextQuestionIndex);

                    // console.log(nextQuestionIndex);
                    // console.log("I am supposed to switch you to page with index: "+nextQuestionIndex);
                    // switch CONTROL
                    // var $carou_sel = $('.carousel').flickity()
                    //                               .flickity('next')
                    //                               .flickity( 'select', 4 );
                    // if(nextQuestionIndex > index){
                      // $carousel.flickity('select', nextQuestionIndex);

                    // }
                    
                    
                    // qualified to move
                    pg_pusher = true;
                  }
                }
                else if(elmtype=="checkbox") {
                  // treat checkboxes
                  // opt_elementofQuest[k].dataset.departure=tt;
                  elchkst = opt_elementofQuest[k].checked; /** Get the checked status of current radio elm */
                  // console.log(elchkst);
                  if (elchkst) { /** the element is checked */
                    // 
                    var dataset=opt_elementofQuest[k].dataset;
                    nextQuestionIndex = opt_elementofQuest[k].dataset.goto;

                    localStorage.setItem("fromid", index);
                    localStorage.setItem("GotoIdx", nextQuestionIndex);


                    // console.log(dataset);
                    // qualified to move
                    pg_pusher = true;
                    // alert(pg_pusher)
                  }
                  
                }
                else if(elmtype=="text") {
                  // treat text boxes
                  // opt_elementofQuest[k].dataset.departure=tt;
                  elchkst = opt_elementofQuest[k].value; /** check if text input has a value */
                  
                  var dataset=opt_elementofQuest[k].dataset;

                  // console.log(dataset);
                  var max = opt_elementofQuest[k].dataset.max;
                  var min = opt_elementofQuest[k].dataset.min;
                  nextQuestionIndex = opt_elementofQuest[k].dataset.goto;

                  localStorage.setItem("fromid", index);
                  localStorage.setItem("GotoIdx", nextQuestionIndex);


                  // console.log("Min: "+ min)
                  // console.log("Max: "+ max)

                  if(elchkst=="") {
                    pg_pusher=false;
                  } else {
                    
                    pg_pusher=true;
                  }

                  /** Code to manage length of characters: JUST FOR PHONE NUMBERS*/
                  // if(max > 0) {
                  //   var len = elchkst.length;

                  //   if ( len > max ) {
                  //     pg_pusher = false;
                  //   } else if(len <= max) {
                  //     pg_pusher = true;
                  //   }
                  // } else if(max==0) { /** When SKIP condition is not set */
                  //   pg_pusher=true;
                  // }


                }
                else if( elmtype=="number" ) {
                  elchkst = opt_elementofQuest[k].value; /** Get the checked status of current radio elm */
                  
                  var max = opt_elementofQuest[k].dataset.maxv;
                  var min = opt_elementofQuest[k].dataset.minv;
                  nextQuestionIndex = opt_elementofQuest[k].dataset.goto;

                  localStorage.setItem("fromid", index);
                  localStorage.setItem("GotoIdx", nextQuestionIndex);


                  // console.log("Min: "+ min)
                  // console.log("Max: "+ max)
                  // console.log("Value: "+ elchkst)

                  // if( elchkst=="" ){
                  //   pg_pusher=false;
                  // } else {
                  //   pg_pusher=true;
                  // }


                  if(max > 0) {
                    if ( elchkst > max ) {
                      pg_pusher = false;
                    } else if(elchkst <= max) {
                      pg_pusher = true;
                    }
                  }else if(max==0) { /** When SKIP condition is not set */
                    pg_pusher=true;
                  }

                }
                else if(elmtype=="image") {
                  // treat text boxes
                  // opt_elementofQuest[k].dataset.departure=tt;
                  // console.log("its image hood")
                  // console.log(opt_elementofQuest.length);

                  // console.log(opt_elementofQuest[k])
                  nextQuestionIndex = opt_elementofQuest[k].dataset.goto;

                  localStorage.setItem("fromid", index);
                  localStorage.setItem("GotoIdx", nextQuestionIndex);

                  var nm="";
                  for (i=0; i<=opt_elementofQuest.length-1; i++){
                    
                    nm = opt_elementofQuest[i].name;
                    if(nm=="myImage"){
                      elchkst = opt_elementofQuest[i].src; /** Get the checked status of current radio elm */                
                      if(elchkst=="") {
                        pg_pusher=false;
                      } else {
                        pg_pusher=true;
                      }
                    }

                  } // for next loop ends
                  

                }
                else if(elmtype=="audio"){
                  nextQuestionIndex = opt_elementofQuest[k].dataset.goto;

                    localStorage.setItem("fromid", index);
                    localStorage.setItem("GotoIdx", nextQuestionIndex);



                }
                else if(elmtype=="select") {
                  // treat text boxes
                  // opt_elementofQuest[k].dataset.departure=tt;
                  elchkst = opt_elementofQuest[k].value; /** Get the checked status of current radio elm */
                  
                  nextQuestionIndex = opt_elementofQuest[k].dataset.goto;

                    localStorage.setItem("fromid", index);
                    localStorage.setItem("GotoIdx", nextQuestionIndex);


                  if(elchkst==""){
                    pg_pusher=false;
                  } else {
                    pg_pusher=true;
                  }

                }
                else if(elmtype=="video"){
                  nextQuestionIndex = opt_elementofQuest[k].dataset.goto;

                    localStorage.setItem("fromid", index);
                    localStorage.setItem("GotoIdx", nextQuestionIndex);

                }

              } /** end FOR LOOP */  

              /** control all switches here: qty, skip tel length etc */ 

              // var $car_cells = document.getElementsByClassName('carousel-cell')[index]; 

  // console.log($car_cells);

  // console.log(index);

              if (!pg_pusher) { /** pg_pusher variable will be set to true at the top and after checking all elements status */
                // restrict movement
                $carousel.flickity('select', index-1, false, true);
                // alert('Response Required here...');
                return;
              }

              /*********************************************************** 
              * swith control to a new PAGE index if available as mapped to the current page dataset goto
              * 
              * 
              * KPIs
              * 1. monitor the key pressed (prev/next) button
              * 2. see to re-writing of arrival page on prev button press
              * 3. monitor the prev button when coming from a flight CALL {send control back to CALLER}
              * 4.
              */
              // if(nextQuestionIndex > 0){
              //   console.log(nextQuestionIndex)
              //   localStorage.setItem("fromid", index);
              //   localStorage.setItem("goto")
              //   // $carousel.flickity('select', nextQuestionIndex, false, true);
              //   // var $carou_sel = $('.carousel').flickity()
              //   //                               .flickity('next')
              //   //                               .flickity( 'select', nextQuestionIndex );

              //   // var flkty = new Flickity('.carousel');
              //   // $carousel.next();
              //   // $carousel.select( 3 );
                
              // }

              
              // console.log(opt_elementofQuest);
              // console.log(opt_elementofQuest[0]);
              // console.log("goto: "+nextQuestionIndex);
              // console.log( typeof nextQuestionIndex);


              
              if(pg_pusher) {
                // writing down the calling page index
                
                // return;
                
              }


              // console.log("Current index Again: "+index);
              if(nextQuestionIndex > 0){
                // index = nextQuestionIndex
              }
              // write Arrival Date for current page and departure date for previous page.
              var parentDOMs  = document.getElementsByClassName("carousel-cell")[index].getElementsByClassName("chtype");//
              // console.log(parentDOMs);

              for(var k=0; k <= parentDOMs.length-1; k++) {
                // console.log(k)
                // console.log(tt)
                // console.log(localStorage.getItem("geolocation"))
                parentDOMs[k].dataset.arrival=tt; /** set the timestamp into dataset  */
                parentDOMs[k].dataset.location=localStorage.getItem("geolocation"); /** set the timestamp into dataset  */
              
              }
              
              
              
              // var opt_elemen  = document.getElementsByClassName("carousel-cell")[index].getElementsByClassName("chtype"); //Get the chtype class from parent DOM of the previous carousel page
              
              // var parentDOMsp = document.getElementsByClassName("carousel-cell")[index - 1].getElementsByClassName("chtype");//
              
              // typ = parentDOMs[index].type; //current DOM page
                
              // console.log("Length: "+parentDOMs.length)
              
              

              // monitor the change event and switch to write for previous page 
              // watch out for prev page after skipping


              

            } //end if (undefined)

          });
          /** end of Change / Settle event of plugin */

          // select an element
          // $carousel.on('select.flickity', (event, index) => {
          //   console.log( 'Flickity select ' + index )
          // });

          // jQuery
          // $carousel.on( 'settle.flickity', function( event, index ) { 
          //   console.log('Mine: '+ index);
            
          //   var nextQuestionIndex = localStorage.getItem("GotoIdx")
          //   localStorage.setItem("GotoIdx", 0);

          //   if(nextQuestionIndex > 0 && index < nextQuestionIndex) {
          //     // $carousel.dest

          //     $carousel.flickity('select', nextQuestionIndex);
              
          //   }

          // });

          $carousel.on('staticClick.flickity', function( event, pointer, cellElement, cellIndex ) {
             
          });

          // $carousel.flickity();

          $(document).ready(function() {
            $('#new_form').click(function() {
              $('.reg').addClass('hidden');
              $('.singin').addClass('hidden');
              $('.questionaire').removeClass('hidden');
              $('.opts').addClass('hidden');
              $('.pict').addClass('hidden');

              $("user").val(localStorage.getItem('username'))
              $("pass").val(localStorage.getItem('passkey'))

              $('.main-carousel').flickity({
                // options
                cellAlign: 'left',
                contain: true,
                fullscreen: false, 
                contain: true, 
                pageDots: false, 
                prevNextButtons : true,
                fade: true
      
            }); 
              // $('').addClass('hidden');
              // $('#project_title').html(data.title);
            
            })

            /** The Cleanup button */

            $('#cleanup').click(function(){

              localStorage.removeItem('_surveytoken');
              var imei = localStorage.getItem('IMEI');

              $('#im').html(imei)

              // alert(imei)
              // $.ajax({
              //   url: "http://75.127.75.161:4000/resetdevice",
              //   cache: false,
              //   type: "GET",
              //   data: "imei="+imei,
              //   dataType: "JSON",
              //   success: function(data){
              //     // alert(data);
              //     // console.log(data.ans);
              //     // console.log(data);
              //   },
              //   error: function(error){
              //     // alert(error.statusText)
              //     // alert(Object.keys(error));
              //   }
              // });
  
            })

            /** The login button pressed */
            $('#logins').click(function() {
              var user = $('#user').val();
              var pass = $('#pass').val();

              var _tokenizer = localStorage.getItem('_surveytoken'); 
                
              if(!_tokenizer) { //unknown devices
                $('.reg').removeClass('hidden');
                $('.singin').addClass('hidden');
                $('.questionaire').addClass('hidden'); 
                $('.opts').addClass('hidden');
                $('.pict').addClass('hidden'); 
                // return;
              }else if(_tokenizer) { //This will execute if there is network and device is known

                var device = localStorage.getItem('IMEI');

                var inObj = {
                  user: user, 
                  pass: pass,
                  imei: device
                };

                // CALL THE SERVER
                $.ajax({
                  url: "http://75.127.75.161:4000/login",
                  cache: false,
                  type: "GET",
                  data: "user="+user+"&pass="+pass+"&imei="+device,
                  dataType: "JSON",
                  success: function(data) {
                    // alert(data.ans);
                    // console.log(data.ans);
                    console.log(data);

                    if(data.resp !== 'success') {
                      swal('Bad Parameters', data.error, 'error');
                      $('.reg').addClass('hidden');
                      $('.singin').removeClass('hidden');
                      $('.questionaire').addClass('hidden');
                      $('.opts').addClass('hidden');
                      $('.pict').addClass('hidden');
            
                      return; 
                    } else if(data.resp=='register'){
                      $('.reg').addClass('hidden');
                      $('.singin').addClass('hidden');
                      $('.questionaire').removeClass('hidden');
                      $('.opts').addClass('hidden');
                      $('.pict').addClass('hidden');
                      return;

                    } else {
                      $('.reg').addClass('hidden');
                      $('.singin').addClass('hidden');
                      $('.questionaire').addClass('hidden');
                      $('.opts').removeClass('hidden');
                      $('.pict').removeClass('hidden');
                      $('#project_title').html(data.title);
                      $('#proj').html(data.title);
            
                      localStorage.setItem('_surveytoken', data.resp);

                      questionaireLayout(data); /**for KNOWN devices */
            
                    }
                  },
                  error: function(error){
                    alert(error.statusText)
                    alert(Object.keys(error));
                  }
                })
              }
              
            }); /**End of Login */


            /** The Register button pressed. This runs only once on every devices. */
            $('#register').click(function() {
              var username = $('#username').val();
              var email    = $('#email').val();
              var phone    = $('#phone').val();

              // please encrypt these values later on.
              localStorage.setItem('username', $('#user').val());
              localStorage.setItem('passkey',  $('#pass').val());

              var u_login = $('#user').val();
              var pass    = $('#pass').val();
              // var devicetype = device.

              var model = localStorage.getItem('maker');
              var imei  = device.serial; //localStorage.getItem('IMEI');
              var gps   = localStorage.getItem('geolocation');
              localStorage.setItem('IMEI',  imei);

              // var GPSArray = gps.split(',');

              var regObj = {
                  user: username,
                  email: email,
                  phone: phone,
                  model: model,
                  imei: imei,
                  u_login: u_login,
                  pass: pass,
                  gps: gps
              };
              
              /**UNKNOWN Device login */
              $.ajax({
                url: "http://75.127.75.161:4000/register",
                cache: false,
                type: "GET",
                data: "user="+username+"&u_login="+u_login+"&pass="+pass+"&phone="+phone+"&imei="+imei+"&email="+email+"&model="+model+"&gps="+gps,
                dataType: "json",
                success: function(resObject) {

                  if(resObject.resp !== 'success') {
                    swal('Bad Params', resObject.resp, 'error');
                    $('.reg').addClass('hidden');
                    $('.singin').removeClass('hidden');
                    $('.questionaire').addClass('hidden');
                    $('.opts').addClass('hidden');
                    $('.pict').addClass('hidden');
                    return;
                  } else {
                    $('.reg').addClass('hidden');
                    $('.singin').addClass('hidden');
                    $('.questionaire').addClass('hidden');
                    $('.opts').removeClass('hidden');
                    $('.pict').removeClass('hidden');
                    $('#proj').html(resObject.projectTitle);


                    /** CREATE A DATABASE on the device FIRST TIMER */
                    var surveyDB = window.sqlitePlugin.openDatabase({name: "surveydb.db", location: 'default'});
                    surveyDB.transaction(function(tx) {
                    tx.executeSql('DROP TABLE IF EXISTS questions_tbl');
                    tx.executeSql('DROP TABLE IF EXISTS webusers');
                    tx.executeSql('DROP TABLE IF EXISTS question_response');
                    tx.executeSql('DROP TABLE IF EXISTS options_tbl');
                    tx.executeSql('DROP TABLE IF EXISTS gps_statusGrabber');

                    tx.executeSql("create table if not exists webusers (refnos bigint(20), usermail varchar(65), fname varchar(25), lname varchar(25), passkey varchar(15) )  ", []
                      , function(tx, res){
                          // alert('Table webusers created successfully...')
                      }
                      , function(err){
                        //  swal('SHELL ERROR', err.message, 'error' );
                        console.log(err.message);
                    });

                    tx.executeSql('INSERT INTO webusers(refnos, usermail, passkey) VALUES (?, ?, ?)', [1, user, pass]
                      , function(tx, resultSet) {
                        //  alert('resultSet.insertId: ' + resultSet.insertId);
                        //  alert('resultSet.rowsAffected: ' + resultSet.rowsAffected);
                        console.log(user);
                        console.log(pass);

                      }, function(error) {
                        //  alert('INSERT error: ' + error.message);
                    }); 

                    tx.executeSql("select count(refnos) as cnt from webusers;", [], function(tx, res) {
                      console.log("res.rows.length: " + res.rows.length + " -- should be 1");
                      console.log("res.rows.item(0).cnt: " + res.rows.item(0).usermail + " -- should be 1");

                      // alert("res.rows.length from WEBUSERS: " + res.rows.length + " -- should be 1");
                      // alert("res.rows.item(0).cnt: " + res.rows.item(0).cnt + " -- should be 1");
                      
                    });

                    tx.executeSql("CREATE TABLE IF NOT EXISTS questions_tbl (refnos bigint(20), project_id bigint(20), question_no tinyint(4), question varchar(250), required varchar(3), usermail varchar(50), status varchar(3) )", []
                      ,function(tx, res) {
                        // alert('Table questions_tbl created successfully...');
                        console.log('got stringlength: ');
                      },function(err) {
                        // alert('questions_tbl table error:'+err.message);
                        
                    });

                    tx.executeSql("CREATE TABLE IF NOT EXISTS question_response (refnos bigint(20), question_refnos tinyint(4), response_text varchar(50), usermail varchar(65), imei varchar(25), location varchar(65),  project_id bigint(20), serviceid bigint(20), q_response_time time, dated timestamp, view_state varchar(10) DEFAULT 'admin', checker tinyint(1) NOT NULL DEFAULT '0' )", []
                      ,function(tx, res) {
                        //  alert('Table question_response created successfully...');
                        console.log('got stringlength: ');
                      },function(err) {
                        // alert('response table error:'+err.message);
                    });

                    tx.executeSql("create table if not exists options_tbl(refnos bigint(20), project_id bigint(20), question_id bigint(20), response_text varchar(150), coltype varchar(50), optionURL varchar(250), gotoquestionid bigint(20), fromquestionid bigint(20))", []
                      , function(tx, res){
                        //  alert('Table options_tbl created successfully...');
                        console.log('got stringlength: ');
                      }, function(err){
                        //  alert('options_tbl table error:'+err.message);
                    });

                    tx.executeSql("create table if not exists gps_statusGrabber(refnos bigint(20), statusdescription varchar(45), imei varchar(25), status varchar(3), dated varchar(45), gps_status_grabbercol varchar(45))", []
                      , function(tx, res) {
                        // alert('Table gps_statusGrabber created successfully...');
                        console.log('got stringlength: ');
                      }, function(err) {
                        // alert('question_response table error:'+err.message);
                    }); 

                    // console.log(resObject.questions);
                    var q_Array = resObject.questions;
                    var opt_Array   = resObject.options;
                    var question, q_refnos, q_required, q_serialnumber;

                    var o_resptext, o_refnos, o_questionid, o_coltype, o_goto, o_from, o_opturl;
                    console.log(q_Array.length);
                    console.log(opt_Array.length);

                    opt_Array.forEach((row, indx) => {
                      console.log(indx);
                      o_resptext = opt_Array[indx].response_text; 
                      o_refnos = opt_Array[indx].refnos;
                      o_questionid = opt_Array[indx].question_id; 
                      o_coltype = opt_Array[indx].coltype;
                      o_opturl = opt_Array[indx].optionURL;

                      o_goto = opt_Array[indx].gotoquestionid;
                      o_from = opt_Array[indx].fromquestionid;

                      tx.executeSql('INSERT INTO options_tbl(refnos, project_id, question_id, response_text, coltype, optionURL, gotoquestionid, fromquestionid) VALUES (?, ?, ?, ?, ?, ?, ?, ?)', [o_refnos, 0, o_questionid, o_resptext, o_coltype, o_opturl, o_goto, o_from]
                        , function(tr, res) {
                          // alert('resultSet.insertId for options_TBL: ' + res.rows.length);
                          console.log('resultSet.rowsAffected: ' + res.rowsAffected);
                  
                        }, function(err) { 
                            // alert('Option_tbl Error: '+ err.message);
                            console.log(err.message);
                      });
                    }) /** End of Options array */
                      
                    // console.log(opt_Array);

                    q_Array.forEach((rec, idx) => { /**Question Array Dumps for first TIMERs */
                      question = q_Array[idx].question; 
                      q_refnos = q_Array[idx].refnos;
                      question = q_Array[idx].question; 
                      q_required = q_Array[idx].required;
                      q_serialnumber = q_Array[idx].question_no;

                      tx.executeSql('INSERT INTO questions_tbl(refnos, project_id, question_no, question, required) VALUES (?, ?, ?, ?, ?)', [q_refnos, 0, q_serialnumber, question, q_required]
                        , function(tr, res){
                          // alert('resultSet.insertId: ' + res.rows.length);
                          // alert('resultSet.rowsAffected: ' + res.rowsAffected);
                  
                        }, function(err){
                            alert('Quest Error: '+ err.message);
                            console.log(err.message);
                      });

                    }); /**End of Question Array dumps */
                      
                  }, function(error) { /** Transaction callbacks here */
                    // OK to close here:
                    console.log('transaction errorsss: ' + error.message);
                    alert('transaction error: ' + error.message);
                    surveyDB.close(() => {
                      console.log('Database is error closed bad.');
                    });
                  }, function() {
                    // OK to close here:
                    alert('transaction ok');
                      
                    surveyDB.close(function() {
                      console.log('database is closed ok');
                    });

                  });

                  localStorage.setItem('_surveytoken', resObject.resp);
                  
                  questionaireLayout(resObject);

                  } /** end of else if */

                  // End line os success callback
                },
                error: function(error) {
                  
                  alert("Error: "+error.statusText);
                  alert(Object.keys(error));

                  console.log(error.responseJSON);
                  console.log(Object.keys(error.responseJSON));
                  
                }
              });
              
            }); /**end register */

          });

          var saver = () => {
            /**THE  SAVE  CODE STARTS HERE
            */ 
            $('#save').attr('disabled', true);
            $('.savebtn').removeClass('hidden');
            
            var referencenumber = +new Date(); // binder
            // console.log(referencenumber)
            var geolocation=localStorage.getItem('geolocation');
            var IMEI = device.serial;
                    
            var cnt = 0;
            var projectid = localStorage.getItem("projectid");
            var questionid;
            var answer;
            var resultObj = '[';
            var usermail= referencenumber;
            var respArray;
            var responseTimer="";
            var stime="", etime="";
            var quest_gps="";
            var imgURL="";

            var pos=0;


            // timerDivs.forEach((rows)=>{
            //   console.log(rows)
            var carsel_Element = document.getElementsByClassName("main-carousel")[0].getElementsByClassName("carousel-cell");
            // .getElementsByClassName("carousel-cell").getElementsByClassName("chtype"); //document.getElementsByClassName('.chtype');
            // console.log(carsel_Element);
            // console.log(carsel_Element.length)
            // console.log(cls_Element.length)

            var chtype_Element;
            for(var y=0; y <= carsel_Element.length-1; y++) {
              /** HERE: pick all .chtype class from cls_Element variable and build the json result to be passed*/
              chtype_Element = carsel_Element[y].getElementsByClassName('chtype');

              // console.log(chtype_Element);
              // console.log(chtype_Element.length);


              // console.log("Y: "+y);

              // chtype_Element.each((index, elm)=>{

              // })

              var len = chtype_Element.length;

              var i=0;

              do {
                var typ = chtype_Element[i].type;
                var nm  = chtype_Element[i].name;
                var st  = chtype_Element[i].checked;

                stime     = chtype_Element[i].dataset.arrival;
                etime     = chtype_Element[i].dataset.departure;
                quest_gps = chtype_Element[i].dataset.location;

                if(typ=="radio") {
                  if(st) {
                    answer =  chtype_Element[i].value;
                    questionid = chtype_Element[i].name;
                      
                    resultObj += '{"elm_type": "'+typ+'", "curr_gps": "'+quest_gps+'", "imei": "'+IMEI+'", "timer": "'+stime +"#"+etime +'", "dated": "'+usermail+'", "project_id": "'+projectid+'", "question_id": "'+questionid+'", "answer": "'+answer+'", "gps": "'+geolocation+'"  }, ';
                  }

                }
                else if( typ=="number") {
                  stime = chtype_Element[i].dataset.arrival;
                  etime = chtype_Element[i].dataset.departure;
                  quest_gps = chtype_Element[i].dataset.location;
                  answer =  chtype_Element[i].value;
                  questionid = chtype_Element[i].name;

                  resultObj += '{"elm_type": "'+typ+'", "curr_gps": "'+quest_gps+'", "imei": "'+IMEI+'", "timer": "'+stime +"#"+etime +'", "dated": "'+usermail+'", "project_id": "'+projectid+'", "question_id": "'+questionid+'", "answer": "'+answer+'", "gps": "'+geolocation+'" }, ';

                }
                else if(typ=="text") {
                  stime     = chtype_Element[i].dataset.arrival;
                  etime     = chtype_Element[i].dataset.departure;
                  quest_gps = chtype_Element[i].dataset.location;
                  answer    =  chtype_Element[i].value;
                  questionid = chtype_Element[i].name;

                  resultObj += '{"elm_type": "'+typ+'", "curr_gps": "'+quest_gps+'", "imei": "'+IMEI+'", "timer": "'+stime +"#"+etime +'", "dated": "'+usermail+'", "project_id": "'+projectid+'", "question_id": "'+questionid+'", "answer": "'+answer+'", "gps": "'+geolocation+'" }, ';

                }
                else if(typ=="image" ) { //images
                  var src_name, src_Id;
                  stime = chtype_Element[i].dataset.arrival;
                  etime = chtype_Element[i].dataset.departure;
                  quest_gps = chtype_Element[i].dataset.location;

                  for(var q=0; q<=chtype_Element.length - 1; q++){
                    src_Id = chtype_Element[q].id;

                    if(src_Id=='myImage'){
                      src_name = chtype_Element[q].src;
                    }

                  }

                  answer =  src_name;
                  questionid = chtype_Element[i].name;

                  resultObj += '{"elm_type": "'+typ+'", "curr_gps": "'+quest_gps+'", "imei": "'+IMEI+'", "timer": "'+stime +"#"+etime +'", "dated": "'+usermail+'", "project_id": "'+projectid+'", "question_id": "'+questionid+'", "answer": "'+answer+'", "gps": "'+geolocation+'" }, ';
                
                }
                else if(typ=="checkbox") {
                  stime = chtype_Element[i].dataset.arrival;
                  etime = chtype_Element[i].dataset.departure;
                  quest_gps = chtype_Element[i].dataset.location;
                  questionid = chtype_Element[i].name;
                  var cst, chst;
                  let chkbox = document.getElementsByName(questionid);

                  var ans="";

                  for(var x = 0; x < chkbox.length; x++){
                    cst = chkbox[x].value;
                    chst = chkbox[x].checked

                    if(chst){
                      ans += cst +', ';
                    }
                  }

                  var chkanswer =  chtype_Element[i].value;
                  answer = ans;
                  resultObj += '{"elm_type": "'+typ+'", "curr_gps": "'+quest_gps+'", "imei": "'+IMEI+'", "timer": "'+stime +"#"+etime +'", "dated": "'+usermail+'", "project_id": "'+projectid+'", "question_id": "'+questionid+'", "answer": "'+answer+'", "gps": "'+geolocation+'" }, ';
                
                }
                else if(typ=='video'){
                  var src_name, src_Id;

                  stime = chtype_Element[i].dataset.arrival;
                  etime = chtype_Element[i].dataset.departure;
                  quest_gps = chtype_Element[i].dataset.location;

                  for(var q=0; q<=chtype_Element.length - 1; q++){
                    src_Id = chtype_Element[q].id;

                    if(src_Id=='myVideo'){
                      src_name = chtype_Element[q].src;

                    }

                  }
                  answer =  src_name;
                  questionid = chtype_Element[i].name;

                  resultObj += '{"elm_type": "'+typ+'", "curr_gps": "'+quest_gps+'", "imei": "'+IMEI+'", "timer": "'+stime +"#"+etime +'", "dated": "'+usermail+'", "project_id": "'+projectid+'", "question_id": "'+questionid+'", "answer": "'+answer+'", "gps": "'+geolocation+'" }, ';
                
                } //last endif 
                
                i++;

              }
              while (i < len);  /** end the do while loop*/
            
            } //carousel-cell loop

             
      
          resultObj = resultObj.substring(0, resultObj.lastIndexOf(","));
      
          //  swal('Error!', 'No server configured for CRUD operation!!!', 'error');
      
          resultObj += ']';

          // alert(resultObj);
          // alert(resultObj.length);

          /**Check the Network status and DETERMINE 
            * eithr to save locally or save on the 
            * iCloud live server */

          var netState = checkConnection();

          console.log(netState);

          if(netState=='No network connection') { //SAVE TO LOCAL DATABASE
              var surveyDB = window.sqlitePlugin.openDatabase({name: "surveydb.db", location: 'default'});
             
              surveyDB.transaction(function(tx) {

                // insert the resultObj Array into the LOCAL table
                resultObj.length;
                
                var elm_type, curr_gps, imei, timer, dated, project_id, question_id, resp, gps;

                for(j=0; j <= resultObj.length; j++) {
                  elm_type = resultObj[j].elm_type;
                  curr_gps = resultObj[j].curr_gps;
                  imei = resultObj[j].imei;
                  timer = resultObj[j].timer;
                  dated = resultObj[j].dated; // binder
                  project_id = resultObj[j].project_id;
                  question_id = resultObj[j].question_id;
                  resp = resultObj[j].answer;
                  gps = resultObj[j].gps;
                
                  tx.executeSql('INSERT INTO question_response(refnos, project_id, question_no, ) VALUES (?, ?, ?)', [1, user, pass]
                    , function(tx, resultSet) {
                      alert('resultSet.insertId: ' + resultSet.insertId);
                      alert('resultSet.rowsAffected: ' + resultSet.rowsAffected);
                
                    }, function(error) {
                      alert('INSERT error: ' + error.message);
                  });

                }                
                
                $('.main-carousel').flickity();

              }, function(error) {
                alert('Insertion error: '+ error.message);
                surveyDB.close();
              }, function(){
                alert('Response inserted Locally...');
                surveyDB.close();
              })
              
          } else {// LIVE SERVER
            $.ajax({
              url: "http://75.127.75.161:4000/saveanswer",
              type: "POST",
              cache: false,
              data: {insertObject: resultObj},
              dataType: "json",
              success: (data) => {
                $('.savebtn').addClass('hidden');
            
                swal('HEY!', 'Thanks for sharing with us...', 'success');
              }, 
              error: (err) => {

              }
            });

            // socket.emit('_saveanswer', JSON.parse(resultObj));
          
            // socket.on('saved', () => {
            //   $('.main-carousel').flickity();
            //     swal('HEY!', 'Thanks for sharing with us...', 'success');
            // });
        

          }

          
          
            /** 
            * 
            * 
            * 
            *
            * 
            */
 
          }/**End save CALL  */

          
          function filter(arr, criteria) {
              return arr.filter(function(obj) {
                  return Object.keys(criteria).every(function(c) {
                  return obj[c] == criteria[c];
                  });
              });
          };

          var refreshPage = () => {
            // var uname=$('#user').val();
            // var upass=$('#pass').val();

            // window.location.reload();
            // $('#user').val(uname);
            // $('#pass').val(upass);

            // $('#logins').click();

            var $carousel = $('.carousel').flickity();
            var isFlickity = true;

            //Clearing previous contents
            $carousel.flickity('destroy');
            $('.carousel').empty();
             
            // init new Flickity
            $carousel.flickity();


            $('.reg').addClass('hidden');
            $('.singin').addClass('hidden');
            $('.questionaire').addClass('hidden');
            $('.opts').removeClass('hidden');
            $('.pict').removeClass('hidden');
            
          }

          var openQuestionaire = () => {
            // alert("here")
            $('.reg').addClass('hidden');
            $('.singin').addClass('hidden');
            $('.questionaire').removeClass('hidden');
            $('.opts').addClass('hidden');
            $('.pict').addClass('hidden');

          }

          var getCoordinate = () => {
            // alert(localStorage.getItem('geolocation'))

            $('#gpscoordinates').html(localStorage.getItem('geolocation'))
          }

        </script>

    </body>
</html>